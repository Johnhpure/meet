# 品号品后端数据表结构分析

## 项目概览

- **项目名称**: 品号品 (pinhaopin)
- **后端技术栈**: TypeScript + Node.js
- **ORM框架**: Prisma
- **数据库**: MySQL
- **数据库配置**: 通过环境变量 `DATABASE_URL` 配置

---

## 数据表清单

当前项目共有 **1 张数据表**：

| 序号 | 表名（数据库） | 模型名（代码） | 业务用途 |
|------|----------------|----------------|----------|
| 1    | registrations  | Registration   | 活动报名信息管理 |

---

## 详细表结构

### 1. Registration (registrations)

**业务用途**: 存储活动报名者的完整信息，包括个人信息、参会类型、携带人员、联系方式和支付凭证。

#### 字段定义

| 字段名 | 数据类型 | 长度/精度 | 约束 | 默认值 | 说明 |
|--------|----------|-----------|------|--------|------|
| `id` | Int | - | 主键、自增 | auto | 报名记录唯一标识 |
| `name` | String | 50 | 非空 | - | 报名者姓名 |
| `idCard` | String | 18 | 非空、唯一 | - | 身份证号（用于防重复报名） |
| `gender` | String | 10 | 非空 | - | 性别 |
| `hasPlusOnes` | Boolean | - | 非空 | false | 是否携带人员 |
| `plusOnesCount` | Int | - | 非空 | 0 | 携带人员数量 |
| `attendanceType` | String | 20 | 非空 | - | 参会类型（如：全天/半天等） |
| `companions` | String | Text | 可空 | null | 携带人员详细信息（JSON格式） |
| `phone` | String | 11 | 非空 | - | 手机号码 |
| `email` | String | 100 | 非空 | - | 邮箱地址 |
| `wechat` | String | 50 | 可空 | null | 微信号 |
| `city` | String | 50 | 非空 | - | 所在城市 |
| `position` | String | 50 | 非空 | - | 职位 |
| `permitImageUrl` | String | 255 | 非空 | - | 许可证/证件图片URL |
| `paymentImageUrl` | String | 255 | 非空 | - | 支付凭证图片URL |
| `totalFee` | Int | - | 非空 | 0 | 总费用（单位：分） |
| `createdAt` | DateTime | - | 非空 | now() | 记录创建时间 |
| `updatedAt` | DateTime | - | 非空 | auto | 记录最后更新时间 |

#### 索引定义

| 索引名 | 索引字段 | 索引类型 | 用途 |
|--------|----------|----------|------|
| PRIMARY | `id` | 主键 | 唯一标识 |
| UNIQUE | `idCard` | 唯一索引 | 防止重复报名 |
| INDEX | `phone` | 普通索引 | 优化按手机号查询 |
| INDEX | `createdAt` | 普通索引 | 优化按时间排序和查询 |

#### 字段约束说明

1. **唯一性约束**:
   - `idCard`: 确保同一身份证号只能报名一次

2. **可空字段**:
   - `wechat`: 微信号为可选信息
   - `companions`: 当 `hasPlusOnes` 为 false 时可为空

3. **自动维护字段**:
   - `createdAt`: 创建时自动设置为当前时间
   - `updatedAt`: 每次更新时自动更新为当前时间

4. **JSON存储字段**:
   - `companions`: 使用 Text 类型存储 JSON 格式数据，灵活支持不定数量的携带人员信息

---

## 表关系图

当前数据库为单表设计，无表间关联关系。

```
┌─────────────────────┐
│   Registration      │
│  (registrations)    │
│                     │
│  - id (PK)          │
│  - name             │
│  - idCard (UK)      │
│  - phone (IDX)      │
│  - ...              │
└─────────────────────┘
```

---

## 业务逻辑说明

### 报名流程相关

1. **身份验证**: 通过 `idCard` 唯一约束确保一人只能报名一次
2. **携带人员管理**: 
   - `hasPlusOnes` 标识是否携带人员
   - `plusOnesCount` 记录携带人员总数
   - `companions` 存储携带人员的详细信息（JSON格式）
3. **费用计算**: `totalFee` 存储总费用，单位为分（避免浮点数精度问题）
4. **凭证管理**: 
   - `permitImageUrl`: 存储许可证或相关证件图片
   - `paymentImageUrl`: 存储支付凭证图片

### 查询优化

- 按手机号查询已建立索引，支持快速查找
- 按创建时间排序已建立索引，适用于报名列表展示

---

## 数据完整性

### 必填字段验证
- 所有个人基本信息字段均为非空
- 联系方式（电话、邮箱）必填
- 凭证图片URL必填

### 数据类型约束
- 手机号限制11位
- 身份证号限制18位
- 各文本字段均有长度限制，防止数据溢出

---

## 扩展建议

当前为单表设计，适用于简单的报名场景。若业务复杂度增加，可考虑：

1. **用户表拆分**: 将用户基本信息与报名信息分离
2. **活动表**: 支持多个活动的报名管理
3. **支付记录表**: 独立管理支付流水和状态
4. **携带人员表**: 将 `companions` JSON 字段规范化为独立表

---

*文档生成时间: 2025-11-19*
*Prisma Schema 路径: `backend/prisma/schema.prisma`*
